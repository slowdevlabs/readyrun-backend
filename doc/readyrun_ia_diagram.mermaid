graph TD
    A[App Launch] --> B{First Time User?}
    B -->|Yes| C[Onboarding Flow]
    B -->|No| D[Main Interface]
    
    C --> C1[Welcome Screen 1-3]
    C1 --> C2[Tutorial Screens]
    C2 --> C3[Location Permission]
    C3 --> C4[Authentication Choice]
    
    C4 --> C4a[Continue as Guest]
    C4 --> C4b[Sign Up/Sign In]
    C4b --> C5[Firebase Auth]
    C5 --> C6[Profile Setup]
    C6 --> D
    C4a --> D
    
    D[Main Interface - Tab Controller] --> E[Home Tab]
    D --> F[Search Tab]
    D --> G[Favorites Tab]
    D --> H[Profile Tab]
    
    E --> E1[Near You Section]
    E --> E2[Popular Section]
    E1 --> E3[Marathon Cards]
    E2 --> E4[Horizontal Scroll]
    E3 --> I[Marathon Detail]
    E4 --> I
    E --> E5[See All] --> J[All Marathons List]
    J --> I
    
    F --> F1[Search Bar]
    F --> F2[Filter Button]
    F1 --> F3[Search Results]
    F2 --> F4[Filter Modal]
    F4 --> F4a[Country Filter]
    F4 --> F4b[Distance Filter]
    F4 --> F4c[Date Filter]
    F4 --> F4d[Price Filter]
    F4 --> F5[Apply Filters]
    F5 --> F3
    F3 --> I
    
    G --> G1{User Authenticated?}
    G1 -->|No| G2[Sign In Prompt]
    G1 -->|Yes| G3{Has Favorites?}
    G3 -->|No| G4[Empty State]
    G3 -->|Yes| G5[Favorites List]
    G2 --> C4b
    G4 --> G6[Explore Marathons] --> E
    G5 --> I
    G5 --> G7[Remove Favorite]
    G7 --> G8[Confirmation Dialog]
    
    H --> H1{User Authenticated?}
    H1 -->|No| H2[Guest Profile View]
    H1 -->|Yes| H3[User Profile View]
    H2 --> H4[Sign In Button] --> C4b
    H3 --> H5[Edit Profile]
    H3 --> H6[Settings Menu]
    H6 --> H6a[Language Settings]
    H6 --> H6b[Units Settings]
    H6 --> H6c[Notification Settings]
    H6 --> H6d[About Screen]
    H3 --> H7[Sign Out]
    
    I[Marathon Detail Screen] --> I1[Hero Image]
    I --> I2[Basic Info]
    I --> I3[Location & Date]
    I --> I4[Available Distances]
    I --> I5[Registration Info]
    I --> I6[Course Map]
    I --> I7[Action Buttons]
    
    I7 --> I8[Favorite Toggle]
    I7 --> I9[Register Now]
    
    I8 --> I8a{User Authenticated?}
    I8a -->|No| K[Auth Required Dialog]
    I8a -->|Yes| I8b[Toggle Favorite State]
    
    I9 --> I9a{User Authenticated?}
    I9a -->|No| L[Registration Options]
    I9a -->|Yes| M[Safari View Controller]
    L --> L1[Continue as Guest] --> M
    L --> L2[Sign In] --> C4b
    
    K --> K1[Continue as Guest] --> M
    K --> K2[Sign In] --> C4b
    
    M --> N[External Registration Site]
    
    style A fill:#007AFF,color:#fff
    style D fill:#FF6B35,color:#fff
    style E fill:#34C759,color:#fff
    style F fill:#34C759,color:#fff
    style G fill:#34C759,color:#fff
    style H fill:#34C759,color:#fff
    style I fill:#FF9500,color:#fff
    style M fill:#FF3B30,color:#fff